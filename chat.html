<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chat</title>
</head>
<body>
    <div id="chat" class="chat"></div>
</body>
<script>
var chat = document.getElementById("chat");
var ws = null;
var channel = null;
var message_show_time = null;


// message example: {"type": "error", "text": "error details"}
// message example: {"type": "debug", "text": "sometext"}
// message example: {"type": "user", "text": "sometext", "color": "#121511", "username": "vova2009"}
function print_message(message) {
    var messageRoot = document.createElement("div");
    messageRoot.className = "message";
    var messageText = document.createElement("p");
    messageText.className = "message-text";

    if (message.type == "debug") {
        messageRoot.className += " debug-message";
    } else if (message.type == "error") {
        messageRoot.className += " error-message";
    } else if (message.type == "user") {
        messageRoot.className += " user-message";
        var messageAuthor = document.createElement("span");
        messageAuthor.className += "message-author";
        var messageSeparator = document.createElement("span");
        messageSeparator.className = "separator";

        messageSeparator.appendChild(document.createTextNode(":"))
        messageAuthor.appendChild(document.createTextNode(message.username))
        messageText.appendChild(messageAuthor);
        messageText.appendChild(messageSeparator);
    }

    messageText.appendChild(document.createTextNode(message.text));
    messageRoot.appendChild(messageText);

    chat.insertBefore(messageRoot, chat.firstChild);
    setTimeout(function() {
        messageRoot.remove()
    }, message_show_time);
}


function connect() {
    ws = new WebSocket("wss://irc-ws.chat.twitch.tv/");

    ws.onclose = (e) => {
        print_message({"type": "error", "text": "reconnection..."})
        connect();
    }

    ws.onopen = (e) => {
        ws.send("CAP REQ :twitch.tv/tags twitch.tv/commands");
        ws.send("PASS SCHMOOPIIE");
        ws.send("NICK justinfan1215");
        ws.send("USER justinfan1215 8 * :justinfan1215");
        ws.send("JOIN #" + channel);
    }

    ws.onmessage = (e) => {
        if (e.data == "PING :tmi.twitch.tv\r\n") {
            self.ws.send("PONG");
            return;
        }

        var message = null;

        //if wellcome message
        if (e.data.match(/^:tmi\.twitch\.tv 001 [^ ]+ :Welcome, GLHF!/)) {
            message = {
                "type": "debug",
                "text": "Connected"
            };
        }

        //if join channel
        var join_result = e.data.match(/:tmi.twitch.tv ROOMSTATE #([^ #]+)$/);
        if (join_result) {
            message = {
                "type": "debug",
                "text": "Joined to " + join_result[1]
            };
        }

        //if message from user
        var result = e.data.match(/color=(#?\w*);.*:(\w+)!\w+@\w+\.tmi\.twitch\.tv PRIVMSG #\w+ :(.*)/m);
        if (result) {
            message = {
                "type": "user",
                "username": result[2],
                "text": result[3],
                "color": result[1]
            };
        }

        if (message) {
            print_message(message);
        }
    }
}


function main() {
    var url_params = new URLSearchParams(window.location.search);
    message_show_time = url_params.get("show_time");
    if (!message_show_time) {
        message_show_time = 60000;
        print_message({
            "type": "debug",
            "text": "'show_time' variable is not specified. default is 60000 (60 seconds)"
        })
    }
    channel = url_params.get('channel');
    if (!channel) {
        print_message({
            "type": "error",
            "text": "no 'channel' variable specified. set '?channel=YOUR_CHANNEL_NAME' afret url"
        })
    }
    connect();
}

main();
</script>

<style>
* {
    margin: 0;
    padding: 0;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 18pt;
}

body {
    background-color: #00000000;
}

.chat {
    background-color: #00000080;
    display: flex;
    flex-direction: column-reverse;
    max-height: 100vh;
    max-width: 100vw;
    overflow: hidden;
}

.message {
    margin-top: .2rem;
    margin-left: .5rem;
}

.user-message {
    color: white;
}

.debug-message {
    color: aquamarine;
}

.error-message {
    color: crimson;
}

.message-author {
    color: burlywood;
}

.message-text {
    font-weight: normal;
    word-wrap: break-word;
}

.separator {
    margin-right: .5rem;
    color: burlywood;
}
</style>

</html>
